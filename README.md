<div align="center">

<img src="https://www.terraform.io/assets/images/logo-text-8c3ba8a6.svg" width="320px" />

# Template Terraform Workload

![Release Version](https://img.shields.io/github/v/release/mundoalem/template-terraform-workload)
![Pipeline Status](https://github.com/mundoalem/template-terraform-workload/actions/workflows/pipeline.yml/badge.svg)
![Contributors](https://img.shields.io/github/contributors/mundoalem/template-terraform-workload)

A DevOps centric template to bootstrap Terraform workload projects.

</div>

## Introduction

This project is a template anyone can use in order to bootstrap a Terraform workload project and deploy their resources
to your preferred provider. The template has a full featured pipeline following the latest DevOps practices.

The directory structure is inspired by projects such as [Terragrunt](https://github.com/gruntwork-io/terragrunt) and
[Terraspace](https://github.com/boltops-tools/terraspace).

You can manage the project locally through the use of [mage](https://magefile.org/), it accepts the following targets:

| Argument | Description                                                                               |
| -------- | ----------------------------------------------------------------------------------------- |
| build    | Runs `terraform init` and `terraform plan` on the specified environment or "all"          |
| clean    | Removes the files and directories generated by the other targets                          |
| config   | Configures terraform with the credentials stored in `TF_CREDENTIALS` environment variable |
| lint     | Runs `terraform fmt` for all code under `infrastructure` directory                        |
| release  | Runs `terraform apply` on the specified environment or "all"                              |
| reset    | Does the same as the `clear` target plus removes `vendor` directory                       |
| scan     | Runs `tfsec` to scan the code for unsafe patterns                                         |
| test     | Runs all tests in `test` directory using `terratest`                                      |

## License

[GPLv3](https://choosealicense.com/licenses/gpl-3.0/)

## Tech Stack

These are the software baked in this template:

- [Terraform](https://www.terraform.io/) v1.0.6
- [Go](https://www.python.org/) v1.17.0
- [Magefile](https://github.com/magefile/mage) v1.11.0
- [tfenv](https://github.com/tfutils/tfenv) v2.2.2
- [tfsec](https://github.com/aquasecurity/tfsec) v0.58.6

## Usage

In order to use this template you first need to clone this repository locally:

```
$ git clone git@github.com:mundoalem/template-terraform-workload.git
$ mv template-terraform-workload/ my-workload-name/
$ cd my-workload-name/
```

Then you can start using it right away, however it may be better to make the project your own:

- Set your preferred Terraform version in `.terraform-version`.
- Add your license to the `LICENSE` file.
- Update the license header in all Terraform and Go source files.
- Update the README.md with your project information.

Then install all dependencies by running:

```
$ go mod vendor
```

Last but not least, all pipeline jobs can also be run locally by invoking `mage`, example:

```bash
$ mage lint
$ mage test
$ mage scan
$ mage build all
$ mage release test
$ mage release live
```

In order to release a package you need to create a release in GitHub assigning a tag to it. The pipeline will be
triggered automatically and at the end of the release step it will attach the source tarballs to the GitHub release.

## Environment Variables

This template is setup to work with [Terraform Cloud](https://app.terraform.io/) so you will need to sign up to this
service and set a Team API Token that can be used in order to run terraform `init`, `plan` and `apply` steps.

If you also require authentication to providers such as AWS and Azure you will have to setup the authentication to those
providers yourself as this template only contemplates the authentication to the remote backend. In that cases, you
probably want to provide the necessary secrets as environment variables, this way `terraform` can read them. It may also
be necessary for you to tweak `magefile.go` and `.github/workflows/pipeline.yml` to meet your requirements.

In the pipeline the build script also looks into a few environment variables that are set by GitHub automatically. These
variables are used by the automation in order to either make decisions or use as input data:

| Variable       | Description                                                           |
| -------------- | --------------------------------------------------------------------- |
| CI             | Used to determine whether we are running locally or inside a pipeline |
| TF_CREDENTIALS | The Team API Token to access workspaces in Terraform Cloud            |

## Feedback

If you have any feedback, please open an [issue](https://github.com/mundoalem/template-terraform-workload/issues).

## Contributing

In particular, this community seeks the following types of contributions:

- Participate in an issue thread or start your own.
- Help us ensure that this repository documentation is comprehensive.
- Implement new features to the project.
- Fix open issues.

## Conduct

We are committed to providing a friendly, safe and welcoming environment for all, regardless of gender, sexual
orientation, disability, ethnicity, religion, income or similar personal characteristic.

Please be kind and courteous. There's no need to be mean or rude. Respect that people have differences of opinion and
that every design or implementation choice carries a trade-off and numerous costs. There is seldom a right answer,
merely an optimal answer given a set of values and circumstances.

Please keep unstructured critique to a minimum. If you have solid ideas you want to experiment with, make a fork and see
how it works.

We will exclude you from interaction if you insult, demean or harass anyone. That is not welcome behavior. We interpret
the term "harassment" as including the definition in the [Citizen Code](http://citizencodeofconduct.org/) of Conduct; if
you have any lack of clarity about what might be included in that concept, please read their definition. In particular,
we don't tolerate behavior that excludes people in socially marginalized groups.

Whether you're a regular contributor or a newcomer, we care about making this community a safe place for you and we've
got your back.

Likewise any spamming, trolling, flaming, baiting or other attention-stealing behavior is not welcome.

## Communication

GitHub issues are the primary way for communicating about specific proposed changes to this project.

In both contexts, please follow the conduct guidelines above. Language issues are often contentious and we'd like to
keep discussion brief, civil and focused on what we're actually doing, not wandering off into too much imaginary stuff.

## FAQ

### Will there ever be support for other continuous integration platforms?

Right now I have no plans to support other platforms like TravisCI, CircleCI or Gitlab. Anyway, it should be quite easy
for you to port the GitHub Actions to any platform you like.

The reason for that is that I don't want to have a `.travis.yml`, a `circleci.yml` and a `.gitlab-ci.yml` all together
in the same place when only one would actually be used. So I want to avoid (for now) cluttering the template with too
many files that might or might not be useful.

### Why don't you support [Terragrunt](https://terragrunt.gruntwork.io/)?

I wanted to support it but once I started playing with it I noticed two red flags with it:

- It does not support the remote backend so it would require me to expect users to first have a solution for their
  backend which is something that would hurt the user experience I was aiming for;

- Input variables do not work veery well for the remote backend and I could not find a clean way to use `tfvars` files
  with the `-var-file` command line argument;

### Why don't you support [Terraspace](https://terraspace.cloud/)?

Unfortunately, Terraspace is a solution coupled with a provider. So I would have to create a template for each of the
main players (AWS, Azure and GCP). Also, if you are using Terraspace I don't think a template will add you any value
since the whole point of Terraspace __is__ to bootstrap the configuration for you.
 
### Where do I put the code for a module that is shared across different environments?

In that case you should put the module in its own repository. You can you our template called
[template-terraform-module](https://github.com/mundoalem/template-terraform-module) to help you.

### What if I use different environments other than `test` and `live`?

This is something I go back and forth and I still can't decide what is the best approach. In general, every organization
will have their own needs, standards and policies for their environments. Some might have only production, others might
have production and test and some enterprises will have production, test, development, acceptance and disaster recovery.

How many environments and how to call them is quite subjective so coming up with a solution that will make everyone
happy is impossible. So, instead of trying to figure out what different sort of people and organizations want I decided that the best I can do is to make the template easy to use and easy to customize.

The `magefile.go` has a global variable called `AllEnvironments` which is a slice containing the environment names. You
only need to update that one and the rest of the code will adapt.

The harder change is in the `.github/workflows/pipeline.yml`. That one will require you to be familiar with GitHub
Actions in order to update it accordingly. Teaching you how to do it is something that I can't do in a few lines.
